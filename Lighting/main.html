<html>
<head>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r71/three.min.js"></script>
	<style>
		/* We want our scene to span the entire window */
		body { margin: 0; }
	</style>
</heda>
<body>
	
	<script id="fragShader" type="shader-code">
		uniform vec2 resolution;//Uniform variables must be declared here first
		uniform float time;
		uniform sampler2D texture;
		uniform sampler2D norm;
		uniform vec3 light;
		void main() {
			vec2 pixel = gl_FragCoord.xy / resolution.xy;
			vec2 lightPos = light.xy;
			lightPos.y = resolution.y - lightPos.y;

			//float dist = distance(gl_FragCoord.xy, light.xy);
			float dist = distance(gl_FragCoord.xy, lightPos);
			// Gray scale over time
			vec4 pixelColor = vec4(0, 0, 0, 1);
			if (dist < resolution.x*light.z)// && dist < resolution.y*light.z)
			    pixelColor = texture2D(texture, pixel);

			vec3 normalVector = texture2D(norm, pixel).xyz;
			normalVector.xy -= 0.5;
			normalVector = normalize(normalVector);
			vec3 lightVector = vec3(lightPos.x - gl_FragCoord.x, lightPos.y - gl_FragCoord.y, 100.0);
			lightVector = normalize(lightVector);

			float diffuse = max(dot(normalVector, lightVector), 0.0);
			float distanceFactor = (1.0 - dist / (resolution.x * light.z));
			gl_FragColor = pixelColor * distanceFactor * diffuse;
		}
	</script>

	<script>
		//@author Omar Shehata. 2015.
		//@Edited Daniel Rodriguez. 2018.
		//We are loading the Three.js library from the cdn here: http://cdnjs.com/libraries/three.js/
		var scene;
		var camera;
		var renderer;

		function scene_setup(){
			//This is all code needed to set up a basic ThreeJS scene
			//First we initialize the scene and our camera
			scene = new THREE.Scene();
			camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );
			//We create the WebGL renderer and add it to the document
			renderer = new THREE.WebGLRenderer();
			renderer.setSize( window.innerWidth, window.innerHeight );
			document.body.appendChild( renderer.domElement );
		}
		scene_setup();

		//Add your code here!
		var shaderCode = document.getElementById("fragShader").innerHTML;
		
		THREE.ImageUtils.crossOrigin = '';//Allows us to load an external image
		var textureURL = "https://raw.githubusercontent.com/tutsplus/Beginners-Guide-to-Shaders/master/Part3/images/blocks.JPG";
		var tex = THREE.ImageUtils.loadTexture( textureURL );
		//var normalURL = "https://raw.githubusercontent.com/tutsplus/Beginners-Guide-to-Shaders/master/Part3/normal_maps/normal_test.jpg"
		var normalURL = "https://raw.githubusercontent.com/tutsplus/Beginners-Guide-to-Shaders/master/Part3/normal_maps/blocks_normal.JPG"

		var normal = THREE.ImageUtils.loadTexture( normalURL );
		
		var uniforms = {
			light: {type: 'v3', value: new THREE.Vector3()},
			resolution: {type: 'v2', value: new THREE.Vector2(window.innerWidth, window.innerHeight)},
			time: {type: 'f', value: 0.0},
			texture: {type: 't', value: tex},
			norm: {type: 't', value: normal}
		}

		var globalTime = new Date().getTime();

		//Create an object to apply the shaders to
		var material = new THREE.ShaderMaterial({uniforms:uniforms, fragmentShader:shaderCode});
		var geometry = new THREE.PlaneGeometry( 10, 10 );
		var sprite = new THREE.Mesh( geometry,material );
		scene.add( sprite );
		sprite.position.z = -3;//Move it back so we can see it


		uniforms.light.value.z = 1.0;
		document.onmousemove = function(event){
		    //Update the light source to follow our mouse
		    uniforms.light.value.x = event.clientX; 
		    uniforms.light.value.y = event.clientY; 
		}
		//Render everything!
		function render() {
			uniforms.resolution.value.x = window.innerWidth;
		    uniforms.resolution.value.y = window.innerHeight;
		    uniforms.time.value = new Date().getTime() - globalTime;
		    
		    //console.log(new Date().getTime() - globalTime);

			requestAnimationFrame( render );
			renderer.render( scene, camera );
		}
		render();

	</script>
</body>
</html>